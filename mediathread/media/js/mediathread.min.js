/*
Mediathread - a javascript library to allow annotating objects.
Copyright 2008-2011 to Columbia University
Center for New Media Teaching and Learning
authors: Schuyler Duveen, Susan Dreher

see: https://github.com/ccnmtl/sherdjs and https://github.com/ccnmtl/mediathread
*/
function addLoadEvent(func){var oldonload=window.onload;if(typeof window.onload!='function'){window.onload=func;}else{window.onload=function(){oldonload();func();}}};var BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version";this.OS=this.searchString(this.dataOS)||"an unknown OS";},searchString:function(data){for(var i=0;i<data.length;i++){var dataString=data[i].string;var dataProp=data[i].prop;this.versionSearchString=data[i].versionSearch||data[i].identity;if(dataString){if(dataString.indexOf(data[i].subString)!=-1)
return data[i].identity;}
else if(dataProp)
return data[i].identity;}},searchVersion:function(dataString){var index=dataString.indexOf(this.versionSearchString);if(index==-1)return;return parseFloat(dataString.substring(index+this.versionSearchString.length+1));},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Internet Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};BrowserDetect.init();function _propertyCount(obj){var count=0;for(var k in obj){if(obj.hasOwnProperty(k)){count++;}}
return count;}
function getVisibleContentHeight(){var viewportwidth;var viewportheight;if(typeof window.innerWidth!=='undefined'){viewportwidth=window.innerWidth;viewportheight=window.innerHeight;}else if(typeof document.documentElement!=='undefined'&&typeof document.documentElement.clientWidth!=='undefined'&&document.documentElement.clientWidth!==0){viewportwidth=document.documentElement.clientWidth;viewportheight=document.documentElement.clientHeight;}else{viewportwidth=document.getElementsByTagName('body')[0].clientWidth;viewportheight=document.getElementsByTagName('body')[0].clientHeight;}
return viewportheight-(20+document.getElementById("header").clientHeight);}
function switcher(a){if(jQuery(a).hasClass("menuclosed")){jQuery(".menuopen").toggleClass("menuopen menuclosed");jQuery("ul.switcher-options").hide();}
jQuery(a).toggleClass('menuclosed menuopen');jQuery(a).parent().children('ul.switcher-options').toggle();}
function updateHelpSetting(user,help_content_id,value){jQuery.post('/yourspace/'+user+'/setting/',{name:help_content_id,value:value});}
function toggleHelp(a,user,parent,help_content_id,callback){jQuery(parent).toggleClass('on off');jQuery("#"+help_content_id).toggleClass('on off');jQuery(a).toggleClass('open');var user_setting=jQuery(parent).hasClass('on')?'True':'False';jQuery.post('/yourspace/'+user+'/setting/',{name:help_content_id,value:user_setting});if(callback){callback();}}
function toggleHelpOverlay(btn,user,help_content_id){var overlay_id="#"+help_content_id+"-overlay";var tab_id="#"+help_content_id+"-tab";var content_id="#"+help_content_id+"-content";if(jQuery(overlay_id).is(":visible")){jQuery(overlay_id).hide();jQuery(tab_id).hide();jQuery(content_id).hide();}else{jQuery(overlay_id).show();jQuery(tab_id).show();jQuery(content_id).show();}
var checked_id="#"+help_content_id+"_checkbox";var elts=jQuery(checked_id);if(elts.length){var checked=jQuery(elts[0]).is(":checked");updateHelpSetting(MediaThread.current_username,help_content_id,!checked);}
return false;}
function getCookie(name){var dc=document.cookie;var prefix=name+"=";var begin=dc.indexOf("; "+prefix);if(begin===-1){begin=dc.indexOf(prefix);if(begin!==0){return null;}}else{begin+=2;}
var end=document.cookie.indexOf(";",begin);if(end===-1){end=dc.length;}
return unescape(dc.substring(begin+prefix.length,end));}
function setCookie(name,value,expires,path,domain,secure){document.cookie=name+"="+escape(value)+
((expires)?"; expires="+expires.toGMTString():"")+
((path)?"; path="+path:"")+
((domain)?"; domain="+domain:"")+
((secure)?"; secure":"");}
function storeData(name,value,expires,path,domain,secure){if(window.localStorage){localStorage[name]=value;}else{setCookie(name,value,expires,path,domain,secure);}}
function retrieveData(name){if(window.localStorage){return localStorage.getItem(name);}else{return getCookie(name);}}
var CollectionList=function(config){var self=this;self.template_label=config.template_label;self.view_callback=config.view_callback;self.create_annotation_thumbs=config.create_annotation_thumbs;self.create_asset_thumbs=config.create_asset_thumbs;self.parent=config.parent;self.selected_view=config.hasOwnProperty('selectedView')?config.selectedView:'Medium';self.citable=config.hasOwnProperty('citable')?config.citable:false;self.switcher_context={};jQuery(window).bind('asset.on_delete',{'self':self},function(event){var self=event.data.self;var div=jQuery(self.parent).find("div.collection-assets");if(!self.citable&&div.length>0){self.scrollTop=jQuery(div[0]).scrollTop();event.data.self.refresh();}});jQuery(window).bind('annotation.on_create',{'self':self},function(event){var self=event.data.self;self.scrollTop=jQuery(self.parent).find("div.collection-assets").scrollTop();event.data.self.refresh();});jQuery(window).bind('annotation.on_delete',{'self':self},function(event){var self=event.data.self;if(!self.citable){self.scrollTop=jQuery(self.parent).find("div.collection-assets").scrollTop();event.data.self.refresh();}});jQuery(window).bind('annotation.on_save',{'self':self},function(event){var self=event.data.self;if(self.citable){self.scrollTop=jQuery(self.parent).find("div.collection-assets").scrollTop();event.data.self.refresh();}});jQuery.ajax({url:'/site_media/templates/'+config.template+'.mustache?nocache=v2',dataType:'text',cache:false,success:function(text){MediaThread.templates[config.template]=Mustache.template(config.template,text);var url=null;self.refresh(config);}});return this;};CollectionList.prototype.refresh=function(config){var self=this;var url;if(config&&config.parent){if(config.view==='all'||!config.space_owner){url=MediaThread.urls['all-space'](config.tag,null,self.citable);}else{url=MediaThread.urls['your-space'](config.space_owner,config.tag,null,self.citable);}}else{var active_modified=('modified'in self.current_records.active_filters)?self.current_records.active_filters.modified:null;var active_tag=('tag'in self.current_records.active_filters)?self.current_records.active_filters.tag:null;url=self.getSpaceUrl(active_tag,active_modified);}
djangosherd.storage.get({type:'asset',url:url},false,function(the_records){self.updateAssets(the_records);});};CollectionList.prototype.selectOwner=function(username){var self=this;djangosherd.storage.get({type:'asset',url:username?MediaThread.urls['your-space'](username,null,null,self.citable):MediaThread.urls['all-space'](null,null,self.citable)},false,function(the_records){self.updateAssets(the_records);});return false;};CollectionList.prototype.editAsset=function(asset_id){var self=this;};CollectionList.prototype.deleteAsset=function(asset_id){var self=this;var url=MediaThread.urls['asset-delete'](asset_id);return ajaxDelete(null,'record-'+asset_id,{'href':url,'item':true,'success':function(){try{jQuery(window).trigger("asset.on_delete",[asset_id]);}catch(e){}}});};CollectionList.prototype.deleteAnnotation=function(annotation_id){var self=this;var asset_id=jQuery('#annotation-'+annotation_id).parents("div.record").children("input.record").attr("value");var url=MediaThread.urls['annotation-delete'](asset_id,annotation_id);return ajaxDelete(null,'annotation-'+annotation_id,{'href':url});};CollectionList.prototype.clearFilter=function(filterName){var self=this;var active_tag=null;var active_modified=null;if(filterName==='tag'){active_modified=('modified'in self.current_records.active_filters)?self.current_records.active_filters.modified:null;}else if(filterName==='modified'){active_tag=('tag'in self.current_records.active_filters)?self.current_records.active_filters.tag:null;}
djangosherd.storage.get({type:'asset',url:self.getSpaceUrl(active_tag,active_modified)},false,function(the_records){self.updateAssets(the_records);});return false;};CollectionList.prototype.filterByDate=function(modified){var self=this;var active_tag=('tag'in self.current_records.active_filters)?self.current_records.active_filters.tag:null;djangosherd.storage.get({type:'asset',url:self.getSpaceUrl(active_tag,modified)},false,function(the_records){self.updateAssets(the_records);});return false;};CollectionList.prototype.filterByTag=function(tag){var self=this;var active_modified=('modified'in self.current_records.active_filters)?self.current_records.active_filters.modified:null;djangosherd.storage.get({type:'asset',url:self.getSpaceUrl(tag,active_modified)},false,function(the_records){self.updateAssets(the_records);});return false;};CollectionList.prototype.filterByClassTag=function(tag){var self=this;djangosherd.storage.get({type:'asset',url:MediaThread.urls['all-space'](tag,null,self.citable)},false,function(the_records){self.updateAssets(the_records);});return false;};CollectionList.prototype.getShowingAllItems=function(json){return!json.hasOwnProperty('space_owner');};CollectionList.prototype.getSpaceUrl=function(active_tag,active_modified){var self=this;if(self.getShowingAllItems(self.current_records)){return MediaThread.urls['all-space'](active_tag,active_modified,self.citable);}else{return MediaThread.urls['your-space'](self.current_records.space_owner.username,active_tag,active_modified,self.citable);}};CollectionList.prototype.createAssetThumbs=function(assets){var self=this;djangosherd.thumbs=[];for(var i=0;i<assets.length;i++){var asset=assets[i];djangosherd_adaptAsset(asset);var target_parent=jQuery(self.parent).find(".gallery-item-"+asset.id)[0];if(!asset.thumbable){if(jQuery(target_parent).hasClass("static-height")){jQuery(target_parent).css({height:'240px'});}}else{var view;switch(asset.type){case'image':view=new Sherd.Image.OpenLayers();break;case'fsiviewer':view=new Sherd.Image.FSIViewer();break;}
djangosherd.thumbs.push(view);var width=jQuery(target_parent).width();var height=(width/asset.width*asset.height+85)+'px';if(jQuery(target_parent).hasClass("static-height")){jQuery(target_parent).css({height:height});}
var obj_div=document.createElement('div');jQuery(target_parent).find('.asset-thumb').append(obj_div);asset.presentation='gallery';asset.x=0;asset.y=0;asset.zoom=1;try{view.html.push(obj_div,{asset:asset});view.setState(asset);}catch(e){}}}};CollectionList.prototype.createThumbs=function(assets){var self=this;djangosherd.thumbs=[];for(var i=0;i<assets.length;i++){var asset=assets[i];djangosherd_adaptAsset(asset);if(asset.thumbable&&asset.annotations){for(var j=0;j<asset.annotations.length;j++){var ann=asset.annotations[j];var view;switch(asset.type){case'image':view=new Sherd.Image.OpenLayers();break;case'fsiviewer':view=new Sherd.Image.FSIViewer();break;}
djangosherd.thumbs.push(view);var obj_div=document.createElement('div');obj_div.setAttribute('class','annotation-thumb');var target_div=jQuery(self.parent).find(".annotation-thumb-"+ann.id)[0];target_div.appendChild(obj_div);asset.presentation='thumb';ann.asset=asset;view.html.push(obj_div,ann);view.setState(ann.annotation);}}}};CollectionList.prototype.updateSwitcher=function(){var self=this;self.switcher_context.display_switcher_extras=!self.switcher_context.showing_my_items;Mustache.update("switcher_collection_chooser",self.switcher_context,{parent:self.parent});jQuery(self.parent).find("a.switcher-choice.owner").unbind('click').click(function(evt){var srcElement=evt.srcElement||evt.target||evt.originalTarget;var bits=srcElement.href.split("/");var username=bits[bits.length-1];if(username==="all-class-members"){username=null;}
return self.selectOwner(username);});};CollectionList.prototype.getAssets=function(){var self=this;return jQuery(self.parent).find('.asset-table').get(0);};CollectionList.prototype.updateAssets=function(the_records){var self=this;self.switcher_context.owners=the_records.owners;self.switcher_context.space_viewer=the_records.space_viewer;self.switcher_context.selected_view=self.selected_view;if(self.getShowingAllItems(the_records)){self.switcher_context.selected_label="All Class Members";self.switcher_context.showing_all_items=true;self.switcher_context.showing_my_items=false;the_records.showing_all_items=true;}else if(the_records.space_owner.username===the_records.space_viewer.username){self.switcher_context.selected_label="Me";self.switcher_context.showing_my_items=true;self.switcher_context.showing_all_items=false;the_records.showing_my_items=true;}else{self.switcher_context.showing_my_items=false;self.switcher_context.showing_all_items=false;self.switcher_context.selected_label=the_records.space_owner.public_name;}
self.current_records=the_records;var n=_propertyCount(the_records.active_filters);if(n>0){the_records.active_filter_count=n;}
Mustache.update(self.template_label,the_records,{parent:self.parent,pre:function(elt){jQuery(elt).hide();},post:function(elt){if(self.create_annotation_thumbs){self.createThumbs(the_records.assets);}else if(self.create_asset_thumbs){self.createAssetThumbs(the_records.assets);}
self.updateSwitcher();jQuery(elt).fadeIn("slow");jQuery(self.parent).find("a.switcher-choice.remove").unbind('click').click(function(evt){var href=jQuery(this).attr("href");var bits=href.split("/");var filterName=bits[bits.length-1];if(filterName==="both"){filterName=null;}
return self.clearFilter(filterName);});jQuery(self.parent).find("p.filterbydate a.switcher-choice").unbind('click').click(function(evt){var srcElement=evt.srcElement||evt.target||evt.originalTarget;var bits=srcElement.href.split("/");var filterName=bits[bits.length-1];if(filterName==="both"){filterName=null;}
return self.filterByDate(filterName);});jQuery(self.parent).find("a.switcher-choice.filterbytag").unbind('click').click(function(evt){var srcElement=evt.srcElement||evt.target||evt.originalTarget;var bits=srcElement.href.split("/");return self.filterByTag(bits[bits.length-1]);});jQuery(self.parent).find("a.collection-choice.edit-asset").unbind('click').click(function(evt){var srcElement=evt.srcElement||evt.target||evt.originalTarget;var bits=srcElement.parentNode.href.split("/");var asset_id=bits[bits.length-1];jQuery(window).trigger('asset.edit',[asset_id]);return false;});jQuery(self.parent).find("a.collection-choice.delete-asset").unbind('click').click(function(evt){var srcElement=evt.srcElement||evt.target||evt.originalTarget;var bits=srcElement.parentNode.href.split("/");var asset_id=bits[bits.length-1];self.deleteAsset(asset_id);return false;});jQuery(self.parent).find("a.collection-choice.delete-annotation").unbind('click').click(function(evt){var srcElement=evt.srcElement||evt.target||evt.originalTarget;var bits=srcElement.parentNode.href.split("/");return self.deleteAnnotation(bits[bits.length-1]);});jQuery(self.parent).find("a.collection-choice.create-annotation").unbind('click').click(function(evt){var srcElement=evt.srcElement||evt.target||evt.originalTarget;var bits=srcElement.parentNode.href.split("/");var asset_id=bits[bits.length-1];jQuery(window).trigger('annotation.create',[asset_id]);return false;});jQuery(self.parent).find("a.collection-choice.edit-annotation").unbind('click').click(function(evt){var srcElement=evt.srcElement||evt.target||evt.originalTarget;var bits=srcElement.parentNode.href.split("/");var annotation_id=bits[bits.length-1];var asset_id=jQuery('#annotation-'+annotation_id).parents("div.record").children("input.record").attr("value");jQuery(window).trigger('annotation.edit',[asset_id,annotation_id]);return false;});if(self.view_callback){self.view_callback();}
jQuery(window).trigger("resize");if(self.scrollTop){jQuery(self.parent).find("div.collection-assets").scrollTop(self.scrollTop);self.scrollTop=undefined;}}});};(function(){var global=this;if(window.Mustache){Mustache.set_pragma_default('EMBEDDED-PARTIALS',true);Mustache.set_pragma_default('FILTERS',true);Mustache.set_pragma_default('DOT-SEPARATORS',true);Mustache.set_pragma_default('?-CONDITIONAL',true);MediaThread.urls={'annotation-form':function(asset_id,annotation_id){return'/asset/'+asset_id+'/annotations/'+annotation_id;},'home-space':function(username){return'/?username='+username;},'your-projects':function(username){return'/yourspace/projects/'+username+'/';},'all-projects':function(){return'/yourspace/projects/';},'sort-projects':function(){return'/project/sort/';},'your-space':function(username,tag,modified,citable){return'/yourspace/'+username+'/asset/?annotations=true'+
(tag?'&tag='+tag:'')+
(modified?'&modified='+modified:'')+
(citable?'&citable='+citable:'');},'all-space':function(tag,modified,citable){return'/yourspace/all/asset/?'+
(tag?'&tag='+tag:'')+
(modified?'&modified='+modified:'')+
(citable?'&citable='+citable:'');},'asset-workspace':function(asset_id,annotation_id){var base='/asset/';if(asset_id){base+=asset_id+'/';if(annotation_id){base+='annotations/'+annotation_id+'/';}}
return base;},'assets':function(username,with_annotations){return'/annotations/'+(username?username+'/':'');},'asset-delete':function(asset_id){return'/asset/delete/'+asset_id+'/';},'asset-view':function(asset_id){return'/asset/'+asset_id+'/';},'asset-json':function(asset_id,with_annotations){return'/asset/json/'+asset_id+(with_annotations?'/?annotations=true':'/');},'annotation-create':function(asset_id){return'/asset/create/'+asset_id+'/annotations/';},'annotation-create-global':function(asset_id){return'/asset/create/'+asset_id+'/global/';},'annotation-edit':function(asset_id,annotation_id){return'/asset/save/'+asset_id+'/annotations/'+annotation_id+'/';},'annotation-delete':function(asset_id,annotation_id){return'/asset/delete/'+asset_id+'/annotations/'+annotation_id;},'project-view':function(project_id){return'/project/view/'+project_id+'/';},'project-feedback':function(project_id){return'/project/view/'+project_id+'/feedback/';},'project-readonly':function(project_id,version){return'/project/view/'+project_id+'/version/'+version+'/';},'project-create':function(){return'/project/create/';},'discussion-view':function(discussion_id){return'/discussion/show/'+discussion_id+"/";},'discussion-create':function(){return'/discussion/create/';},'comment-edit':function(comment_id){return'/discussion/comment/'+comment_id;},'comment-create':function(){return'/comments/post/';}};Mustache.Renderer.prototype.filters_supported.url=function(name,context,args){var url_args=this.map(args,function(a){return this.get_object(a,context,this.context);},this);return MediaThread.urls[name].apply(this,url_args);};Mustache.Renderer.prototype.filters_supported.ellipses=function(name,context,args){var length=parseInt(args[0],10);var value=String(this.get_object(name,context,this.context)||'');if(value.length>length){value=value.substring(0,length)+"...";}
return value;};Mustache.Renderer.prototype.filters_supported.upper=function(name,context,args){var value=String(this.get_object(name,context,this.context)||'');return value.toUpperCase();};Mustache.Renderer.prototype.filters_supported['default']=function(name,context,args){var lookup=this.get_object(name,context,this.context);if(lookup){return lookup;}else{return args[0];}};}})();(function(){window.PanelFactory=new(function PanelFactoryAbstract(){this.create=function(el,parent,type,panels,space_owner){var handler=null;if(type==="project"){handler=new ProjectPanelHandler(el,parent,panels,space_owner);}else if(type==="discussion"){handler=new DiscussionPanelHandler(el,parent,panels,space_owner);}else if(type==="asset"){handler=new AssetPanelHandler(el,parent,panels,space_owner);}
return handler;};})();window.PanelManager=new(function PanelManagerAbstract(){var self=this;this.init=function(options,panels){self.options=options;self.panelHandlers=[];self.el=jQuery("#"+options.container)[0];jQuery.ajax({url:options.url,dataType:'json',cache:false,success:function(json){self.panels=json.panels;self.space_owner=json.space_owner;self.loadTemplates(0);}});jQuery(window).resize(function(){self.resize();});};this.count=function(){return self.panelHandlers.length;};this.resize=function(){var visible=getVisibleContentHeight();jQuery(self.el).css('height',visible+"px");};this.loadTemplates=function(idx){if(idx===self.panels.length){self.loadContent();}else if(MediaThread.templates[self.panels[idx].template]){self.loadTemplates(++idx);}else{jQuery.ajax({url:'/site_media/templates/'+self.panels[idx].template+'.mustache?nocache=v3',dataType:'text',cache:false,success:function(text){MediaThread.templates[self.panels[idx].template]=Mustache.template(self.panels[idx].template,text);self.loadTemplates(++idx);}});}};this.loadContent=function(){for(var i=0;i<self.panels.length;i++){var panel=self.panels[i];if(!panel.hasOwnProperty("loaded")){var lastCell=jQuery("#"+self.options.container+" tr:first td:last");lastCell.before(Mustache.tmpl(panel.template,panel));var newCell=jQuery(lastCell).prev().prev()[0];var handler=PanelFactory.create(newCell,self.el,self.panels[i].context.type,self.panels[i],self.space_owner);self.panelHandlers.push(handler);jQuery(newCell).find(".pantab-container").bind('click',{handler:handler,isSubpanel:true},function(event){self.slidePanel(this,event);});jQuery(newCell).next(".pantab-container").bind('click',{handler:handler,isSubpanel:false},function(event){self.slidePanel(this,event);});panel.loaded=true;self.verifyLayout(newCell);}}};this.slidePanel=function(pantab_container,event){var panel=jQuery(pantab_container).prevAll("td.panel-container")[0];var param,panelTab;if(jQuery(panel).hasClass("minimized")||jQuery(panel).hasClass("maximized")){param=jQuery(panel).hasClass("minimized")?"maximized":"minimized";jQuery(panel).toggleClass("minimized maximized");jQuery(panel).trigger('panel_state_change',[param]);panelTab=jQuery(pantab_container).children("div.pantab")[0];jQuery(panelTab).toggleClass("minimized maximized");if(param==="maximized"){jQuery(panel).siblings('td.panel-container').hide();jQuery(panel).css("display","table-cell");}else{jQuery(panel).siblings('td.panel-container').show();}
self.verifyLayout(panel);jQuery(window).trigger("resize");}else{param=jQuery(panel).hasClass("open")?"closed":"open";jQuery(panel).toggleClass("open closed");jQuery(panel).trigger('panel_state_change',[param]);panelTab=jQuery(pantab_container).children("div.pantab")[0];jQuery(panelTab).toggleClass("open closed");self.verifyLayout(panel);jQuery(window).trigger("resize");}};this.openSubPanel=function(subpanel){if(subpanel){jQuery(subpanel).removeClass("closed").addClass("open");jQuery(subpanel).trigger('panel_state_change',['open']);var container=jQuery(subpanel).nextAll("td.pantab-container");var panelTab=jQuery(container[0]).children("div.pantab");jQuery(panelTab[0]).removeClass("closed");jQuery(panelTab[0]).addClass("open");self.verifyLayout(subpanel);jQuery(window).trigger("resize");}};this.closeSubPanel=function(view){var subpanel=jQuery(view.el).find("td.panel-container.open")[0];jQuery(subpanel).removeClass("open").addClass("closed");jQuery(subpanel).trigger('panel_state_change',['closed']);var panelTab=jQuery(subpanel).next().next().children("div.pantab")[0];jQuery(panelTab).toggleClass("open closed");self.verifyLayout(subpanel);jQuery(window).trigger("resize");};this.verifyLayout=function(panel){var screenWidth=jQuery(window).width();var tableWidth=jQuery(self.el).width();var elts=jQuery(panel).parents("td.panel-container.open");var parent=elts.length>0?elts[0]:null;var a=jQuery(self.el).find("table.panel-subcontainer td.panel-container.minimized");for(var i=0;i<a.length&&tableWidth>screenWidth;i++){var subcontainer=a[i];jQuery(subcontainer).css("display","none");tableWidth=jQuery(self.el).width();}
a=jQuery(self.el).find("table.panel-subcontainer tbody tr td.panel-container.open").not(".alwaysopen");for(i=0;i<a.length&&tableWidth>screenWidth;i++){var p=a[i];if(panel!==p){jQuery(p).removeClass("open").addClass("closed");jQuery(p).trigger('panel_state_change',['closed']);var container=jQuery(p).nextAll("td.pantab-container");var panelTab=jQuery(container[0]).children("div.pantab");jQuery(panelTab[0]).removeClass("open").addClass("closed");tableWidth=jQuery(self.el).width();}}
a=jQuery(self.el).find("tr.sliding-content-row").children("td.panel-container.open:visible").not(".alwaysopen");if(a.length>1){for(i=0;i<a.length&&tableWidth>screenWidth;i++){if(a[i]!==panel&&a[i]!==parent){jQuery(a[i]).removeClass("open").addClass("closed");jQuery(a[i]).trigger('panel_state_change',['closed']);var parentContainer=jQuery(a[i]).nextAll("td.pantab-container")[0];var parentPanelTab=jQuery(parentContainer).children("div.pantab")[0];jQuery(parentPanelTab).removeClass("open").addClass("closed");tableWidth=jQuery(self.el).width();}}}};this.newPanel=function(options){jQuery.ajax({type:'POST',url:options.url,dataType:'json',data:options.params,success:function(json){if(options.callback){options.callback(json);}else{var length=self.panels.push(json);self.loadTemplates(length-1);}}});};this.openPanel=function(panel){if(jQuery(panel).hasClass("closed")){jQuery(panel).removeClass("closed").addClass("open");jQuery(panel).trigger('panel_state_change',['open']);var panelTab=jQuery(panel).next().children("div.pantab")[0];jQuery(panelTab).toggleClass("open closed");self.verifyLayout(panel);jQuery(window).trigger("resize");}};this.maximizePanel=function(panel){if(jQuery(panel).hasClass("minimized")){jQuery(panel).removeClass("minimized").addClass("maximized");jQuery(panel).siblings('td.panel-container').hide();var panelTab=jQuery(panel).next().children("div.pantab")[0];jQuery(panelTab).parent().removeClass("minimized").addClass("maximized");jQuery(panelTab).removeClass("minimized").addClass("maximized");self.verifyLayout(panel);jQuery(window).trigger("resize");}};})();})();var MediathreadAnalytics=function(tracker){var self=this;self.tracker=tracker;jQuery(window).bind('video.create',{'self':self},function(event,id,type){_gaq.push(['_trackEvent','video','create',type,id]);});jQuery(window).bind('video.play',{'self':self},function(event,id,type){_gaq.push(['_trackEvent','video','play',type,id]);});jQuery(window).bind('video.pause',{'self':self},function(event,id,type){_gaq.push(['_trackEvent','video','pause',type,id]);});jQuery(window).bind('video.finish',{'self':self},function(event,id,type){_gaq.push(['_trackEvent','video','finish',type,id]);});};var browserblock='<div class="nosupport_close"><a href="#" onclick="javascript:this.parentNode.parentNode.style.display=\'none\'; return false;" title="Close this notice"></a></div><div class="browsers"> <div class="alert"> <div class="icon"></div><!-- class="icon" --> <div class="content"> <div class="title" id="nobrowserwarning">browsermsg1</div><!-- class="title" --> <div class="comment"><span id="minreqversion"></span> <span  id="nobrowsercomment">browsermsg2</span></div><!-- class="comment" --> </div><!-- class="content" --> </div><!-- class="alert" --> <div class="solution"><div class="browser" id="chrome"> <div class="icon"></div><!-- class="icon" --> <div class="content"> <div class="title"> <a id="chromeurl" href="http://www.google.com/chrome/" title="Dowload the latest Google Chrome browser.">Chrome</a> </div><!-- class="title" --> </div><!-- class="content" --> </div><!-- class="chrome" --> <div class="browser" id="firefox"> <div class="icon"></div><!-- class="icon" --> <div class="content"> <div class="title"> <a id="firefoxurl" href="http://getfirefox.com" title="Dowload the latest Firefox browser.">Firefox</a> </div><!-- class="title" --> </div><!-- class="content" --> </div><!-- class="firefox" --> <div class="browser" id="safari"> <div class="icon"></div><!-- class="icon" --> <div class="content"> <div class="title"> <a id="safariurl" href="http://www.apple.com/safari/" title="Dowload the latest Safari browser.">Safari</a> </div><!-- class="title" --> </div><!-- class="content" --> </div><!-- class="safari" --> <div class="browser" id="msie"> <div class="icon"></div><!-- class="icon" --> <div class="content"> <div class="title"> <a id="ieurl" href="http://windows.microsoft.com/ie" title="Dowload the latest Internet Explorer browser.">Internet Explorer</a> </div><!-- class="title" --> </div><!-- class="content" --> </div><!-- class="msie" --> </div><!-- class="solution" --> <div class="visualclear"></div> </div><!-- browsers -->';var browserlist;function buildshieldbox(){if(!document.getElementById("shieldbox")){return false;}
var shieldwarningbox=document.getElementById("shieldbox");shieldwarningbox.className="warningmessage";shieldwarningbox.innerHTML=browserblock;var nobrowserwarningdiv=document.getElementById("nobrowserwarning");var nobrowsercommentdiv=document.getElementById("nobrowsercomment");nobrowserwarningdiv.innerHTML='You are using '+BrowserDetect.browser+' v.'+BrowserDetect.version+', an unsupported browser.';nobrowsercommentdiv.innerHTML='<br /><br />For a better experience using this site, please upgrade to a recommended recent web browser.';var thisbrowsername=null;if(BrowserDetect.browser==='Internet Explorer'){thisbrowsername='MSIE';}
for(var key in browserlist){if(browserlist.hasOwnProperty(key)){if(BrowserDetect.browser.toLowerCase()===key.toLowerCase()||(thisbrowsername&&thisbrowsername.toLowerCase()===key.toLowerCase())){document.getElementById("minreqversion").innerHTML='The minimum required version for this browser is '+browserlist[key]+'.';}
var currentclass=document.getElementById(key.toLowerCase()).className;document.getElementById(key.toLowerCase()).className=currentclass+' isrequired';}}}
function shieldbrowser(reqbrowser){var browsername=false;var versionmismatch=false;var thisbrowsername=null;if(BrowserDetect.browser==='Internet Explorer'){thisbrowsername='MSIE';}
for(var key in reqbrowser){if(BrowserDetect.browser.toLowerCase()===key.toLowerCase()||(thisbrowsername&&thisbrowsername.toLowerCase()===key.toLowerCase())){browsername=true;if((BrowserDetect.version)<reqbrowser[key]){versionmismatch=true;}}}
if(!browsername||versionmismatch){browserlist=reqbrowser;addLoadEvent(buildshieldbox);}}
(function(){window.AnnotationList=new(function AnnotationListAbstract(){var self=this;this.init=function(config){this.layers={};this.active_annotation=null;this.active_asset=null;this.active_asset_annotations=null;this.config=config;this.view_callback=config.view_callback;this.update_history=config.update_history!==undefined?config.update_history:true;this.user_settings={'help_item_detail_view':true};if(String(window.location.hash).match(/edit_state=new/)){self.config.edit_state="annotation.create";window.location.hash='';}
djangosherd.assetview.clipform.setState({'start':0,'end':0},{'mode':'reset'});this.refresh(config);if(this.update_history){jQuery(window).bind("popstate",function(event){if(event.originalEvent.state){window.AnnotationList._update({'annotation_id':event.originalEvent.state.annotation_id},"annotation-current");}});jQuery(window).bind("hashchange",function(){var asset_id=null;var annotation_id=null;var xywh=null;var params=window.location.pathname.split('/');for(var i=0;i<params.length;i++){var prev=i-1;if(prev>-1){if(params[prev]==='asset'){asset_id=params[i];}else if(params[prev]==='annotations'){annotation_id=params[i];}}}
var config={};if(window.location.hash){var annotation_query=djangosherd.assetview.queryformat.find(document.location.hash);if(annotation_query.length){config.xywh=annotation_query[0];}else{var annid=String(window.location.hash).match(/annotation_id=([.\d]+)/);if(annid!==null){config.annotation_id=Number(annid[1]);}}}
window.AnnotationList._update(config,"annotation-current",xywh);});return this;}};this.refresh=function(config){if(config.asset_id){this.grouping=null;this.highlight_layer=null;djangosherd.storage.get({id:config.asset_id,type:'asset',url:MediaThread.urls['asset-json'](config.asset_id,true)},false,function(asset_full){self.asset_full_json=asset_full;self.user_settings=asset_full.user_settings;var theAsset;for(var key in asset_full.assets){if(asset_full.assets.hasOwnProperty(key)){theAsset=asset_full.assets[key];break;}}
self.active_asset=theAsset;self.active_asset_annotations=asset_full.annotations;if(window.location.hash){var annotation_query=djangosherd.assetview.queryformat.find(document.location.hash);if(annotation_query.length){config.xywh=annotation_query[0];}else{var annid=String(window.location.hash).match(/annotation_id=([.\d]+)/);if(annid!==null){config.annotation_id=Number(annid[1]);}}}
self._update(config,"asset-view-details");self._addHistory(true);var frm=document.forms['annotation-list-filter'];if(frm){frm.elements.showall.checked=retrieveData('annotation-list-filter__showall');jQuery(frm.elements.groupby).val(retrieveData('annotation-list-filter__group')||'author');jQuery(frm.elements.showall).change(self.showHideAnnotations);jQuery(frm.elements.groupby).change(function(){var val=jQuery(this).val();storeData('annotation-list-filter__group',val);self.groupBy(val);});self.groupBy(jQuery(frm.elements.groupby).val());}});}};this.showHideAnnotations=function(){var show=document.forms['annotation-list-filter'].elements.showall.checked;storeData('annotation-list-filter__showall',show||'');if(show){self.layers[self.grouping].show();}else{self.layers[self.grouping].hide();}};this.groupBy=function(grouping){if(this.grouping===grouping||!(self.active_asset&&self.active_asset.id)){return;}
if(this.grouping){this.layers[this.grouping].hide();}
if(!this.layers[grouping]){this.layers[grouping]=djangosherd.assetview.layer();if(!this.layers[grouping]){this.layers[grouping]={removeAll:function(){},add:function(){},remove:function(){},show:function(){},hide:function(){}};}else{this.layers[grouping].create(grouping,{title:' ',onmouseenter:function(id,name){self.highlight(id);},onmouseleave:function(id,name){self.unhighlight();},zIndex:300});}}
this.grouping=grouping;this.showHideAnnotations();this.resetHighlightLayer();switch(grouping){case'tag':this.layers[grouping].color_by=function(ann){if(ann.metadata.tags.length){var tags=[];for(var k=0;k<ann.metadata.tags.length;k++){tags.push(ann.metadata.tags[k].name);}
return tags;}else{return[String.fromCharCode(127)+'No Tags'];}};break;case'author':this.layers[grouping].color_by=function(ann){return[ann.metadata.author_name];};break;}
self.updateAnnotationList();};this.updateAnnotationList=function(){var frm=document.forms['annotation-list-filter'];if(!frm){return;}
var asset_full=self.asset_full_json;var grouping=self.grouping;var context={'annotation_list':[]};var cats={};var user_listing=false;self.layers[grouping].removeAll();DjangoSherd_Colors.reset(grouping);for(var i=0;i<asset_full.annotations.length;i++){var ann=asset_full.annotations[i];if(self.active_annotation){ann.active_annotation=(ann.id===self.active_annotation.id);}
if(ann.metadata){var titles=self.layers[grouping].color_by(ann);for(var j=0;j<titles.length;j++){var title=titles[j];var color=DjangoSherd_Colors.get(title);if(ann.annotation){self.layers[grouping].add(ann.annotation,{'id':ann.id,'color':color});}
if(!cats[title]){cats[title]={'title':title,'color':color,'annotations':[]};if(title&&title===MediaThread.user_full_name){user_listing=title;}else{context.annotation_list.push(title);}}
cats[title].annotations.push(ann);}}}
context.annotation_list.sort();if(user_listing){context.annotation_list.unshift(user_listing);}
for(var k=0;k<context.annotation_list.length;k++){context.annotation_list[k]={'category':cats[context.annotation_list[k]]};}
Mustache.update('annotation-list',context,{pre:function(elt){jQuery(elt).hide();jQuery("div.accordion").accordion("destroy");},post:function(elt){var options={autoHeight:false,collapsible:true,active:false};jQuery(elt).show();jQuery('li.annotation-listitem',elt).each(self.decorateLink);jQuery("div.accordion").accordion(options);if(self.active_annotation){var active=jQuery("#accordion-"+self.active_annotation.id)[0];var parent=jQuery(active).parents("div.accordion");jQuery(parent).accordion("activate",active);jQuery(active).find('input.annotation-listitem-icon').show();setTimeout(function(){var list=jQuery(active).offsetParent()[0];jQuery(list).scrollTop(jQuery(list).scrollTop()+jQuery(active).position().top);},200);}
jQuery("div.accordion").accordion({'changestart':self.showAnnotation});}});};this.resetHighlightLayer=function(){if(this.highlight_layer){this.highlight_layer.destroy();}
this.highlight_layer=djangosherd.assetview.layer();if(this.highlight_layer){this.highlight_layer.create('focus',{zIndex:200,title:' '});}};this.unhighlight=function(){if(self.highlighted_nodes){jQuery(self.highlighted_nodes).removeClass('highlight');}
if(self.highlight_layer){self.highlight_layer.removeAll();}else{self.resetHighlightLayer();}};this.highlight=function(ann_id){self.unhighlight();self.highlighted_nodes=jQuery('.annotation-listitem-'+ann_id).addClass('highlight').toArray();if(self.highlight_layer){djangosherd.storage.get({'id':ann_id,'type':'annotations'},function(ann){self.highlight_layer.add(ann.annotation,{id:ann.id,color:'black',bgcolor:'highlight',pointerEvents:'none',zIndex:1});});}};this.decorateLink=function(li){if(self.highlight_layer){jQuery(this).mouseenter(function(evt){self.highlight(jQuery(this).attr('data-id'));}).mouseleave(function(evt){self.unhighlight();});}};this.showExportDialog=function(anchor,asset_id){var self=this;var element=jQuery(".export-finalcutpro")[0];var list=jQuery(element).find("ul.selections")[0];jQuery(list).find('li').remove();if(this.hasOwnProperty('active_asset_annotations')){for(var i=0;i<this.active_asset_annotations.length;i++){var ann=this.active_asset_annotations[i];if(ann.annotation){var li="<li>"+"<span class='ui-icon-reverse ui-icon-arrowthick-2-n-s'></span>"+"<input readonly='readonly' type='text' name='"+ann.id+"' value='"+ann.metadata.title+"'></input></li>";jQuery(list).append(li);}}}
jQuery(list).sortable({containment:'parent'}).disableSelection();jQuery(element).dialog({buttons:[{text:"Export",click:function(){jQuery("form[name=export-finalcutpro]").trigger('submit');jQuery(this).dialog("close");}}],draggable:true,resizable:true,modal:true,width:425,position:"top",zIndex:10000});return false;};this.onExportSubmit=function(evt){var selections=jQuery('ul.selections li input[type=text]');for(var i=0;i<selections.length;i++){var id=jQuery(selections[i]).attr('name');jQuery(selections[i]).attr("name",i);jQuery(selections[i]).attr("value",id);}
return true;};this.showHelp=function(){jQuery("#asset-view-overlay, #asset-view-help, #asset-view-help-tab").show();return false;};this.dismissHelp=function(){jQuery("#asset-view-overlay, #asset-view-help, #asset-view-help-tab").hide();var checked=jQuery("#asset-view-show-help").is(":checked");updateHelpSetting(MediaThread.current_username,'help_item_detail_view',!checked);return false;};this.showAsset=function(){self._update({'level':'item','asset_id':self.active_asset.id},"annotation-current");self._addHistory(false);};this.editItem=function(){var form=jQuery("#edit-global-annotation-form");jQuery("div.metadata-value, #annotations-organized-container, #annotation-current, div.actions").fadeOut(function(){jQuery(form).find(".metadata-value-edit").fadeIn();});};this.cancelItem=function(){jQuery(window).trigger("annotation.on_cancel",[]);var form=jQuery("#edit-global-annotation-form");jQuery(form).find(".metadata-value-edit").fadeOut(function(){jQuery("div.metadata-value, #annotations-organized-container, #annotation-current, div.actions").fadeIn();});return false;};this.deleteItem=function(event,record,asset_id){event.stopPropagation();var url=MediaThread.urls['asset-delete'](asset_id);ajaxDelete(null,null,{'href':url,'item':true,'success':function(){jQuery(window).trigger("asset.on_delete",[asset_id]);}});return false;};this.saveItem=function(saveButton){var frm=jQuery(saveButton).parents('form')[0];var tag_field=frm.elements['annotation-tags'];if(tag_field){var tags=tag_field.value.split(',');for(var i=0;i<tags.length;i++){if(tags[i].trim().length>25){alert('The '+tags[i]+' is too long. Tags should be less than 25 characters. '+'And, be sure to separate your tags with commas.');return false;}}}
jQuery(saveButton).attr("disabled","disabled").attr("value","Saving...").addClass("saving");jQuery.ajax({type:'POST',url:frm.action,data:jQuery(frm).serializeArray(),dataType:'json',error:function(){jQuery(saveButton).removeAttr("disabled").attr("value","Save").removeClass("saving");alert('There was an error saving your changes.');},success:function(json,textStatus,xhr){djangosherd.storage.get({id:json.asset.id,type:'asset',url:MediaThread.urls['asset-json'](json.asset.id,true)},false,function(asset_full){if(json.annotation.creating){jQuery(window).trigger("annotation.on_create",[]);}else{jQuery(window).trigger("annotation.on_save",[]);}
self.asset_full_json=asset_full;var theAsset;for(var key in asset_full.assets){if(asset_full.assets.hasOwnProperty(key)){theAsset=asset_full.assets[key];break;}}
self.active_asset=theAsset;self.active_asset_annotations=asset_full.annotations;jQuery(saveButton).removeAttr("disabled");jQuery(saveButton).removeClass("saving");jQuery(saveButton).attr("value","Save");var context={'asset-current':self.active_asset};Mustache.update("asset-global-annotation",context,{pre:function(elt){jQuery(elt).hide();},post:function(elt){jQuery(elt).fadeIn("slow",function(){jQuery("#annotations-organized-container, #annotation-current").fadeIn();jQuery(window).trigger("resize");});}});});}});return false;};this.showAnnotation=function(event,ui){if(ui.newHeader.length>0){jQuery('input.annotation-listitem-icon').hide();jQuery(ui.newHeader).find('input.annotation-listitem-icon').show();var new_annotation_id=jQuery(ui.newHeader).data("id");self._update({'annotation_id':new_annotation_id},"annotation-current");self._addHistory(false);var group=jQuery(ui.newHeader).parents('li.annotation-group')[0];jQuery(group).siblings().find('div.accordion').accordion("activate",false);setTimeout(function(){var list=jQuery(ui.newHeader).offsetParent()[0];jQuery(list).scrollTop(jQuery(list).scrollTop()+jQuery(ui.newHeader).position().top-10);},200);}};this.deleteAnnotation=function(event,record,annotation_id){event.stopPropagation();var self=this;if(annotation_id===self.active_annotation.id){var url=MediaThread.urls['annotation-delete'](self.active_asset.id,annotation_id);ajaxDelete(null,"accordion-"+annotation_id,{'href':url,'success':this.deleteAnnotationComplete});}
return false;};this.deleteAnnotationComplete=function(){self.refresh({asset_id:self.active_asset.id});jQuery(window).trigger("annotation.on_delete",[]);};this.cancelAnnotation=function(){jQuery(window).trigger("annotation.on_cancel",[]);var annotation_id=self.active_annotation?self.active_annotation.id:null;jQuery("#asset-details-annotations-current").fadeOut(function(){self._update({'annotation_id':annotation_id,'editing':false},"annotation-current");if(self.active_annotation){var active=jQuery("#accordion-"+self.active_annotation.id)[0];var parent=jQuery(active).parents("div.accordion");jQuery(parent).accordion("activate",active);}
jQuery("#asset-global-annotation, #annotations-organized").fadeIn();});return false;};this.newAnnotation=function(){var context={'annotation':{'editing':true,'showCancel':true,'metadata':{'author':{'id':MediaThread.current_user},'author_name':MediaThread.user_full_name}}};jQuery("#asset-global-annotation, #annotations-organized").fadeOut(function(){Mustache.update('annotation-current',context,{post:function(elt){djangosherd.assetview.clipform.html.push('clipform-display',{asset:{}});djangosherd.assetview.setState({});djangosherd.assetview.clipform.setState({'start':0,'end':0},{'mode':'create'});jQuery("#asset-details-annotations-current").fadeIn();}});});};this.editAnnotation=function(){jQuery("#asset-global-annotation, #annotations-organized").fadeOut(function(){self._update({'annotation_id':self.active_annotation.id,'editing':true},"annotation-current");});return false;};this.copyAnnotation=function(){var context={'annotation':{'editing':true,'copying':true,'showCancel':true,'metadata':{'body':self.active_annotation.metadata.body,'tags':self.active_annotation.metadata.tags,'title':self.active_annotation.metadata.title,'author':{'id':MediaThread.current_user},'author_name':MediaThread.user_full_name},'range1':self.active_annotation.range1,'range2':self.active_annotation.range2,'annotation_data':self.active_annotation.annotation_data}};jQuery("#asset-global-annotation, #annotations-organized").fadeOut(function(){Mustache.update('annotation-current',context,{pre:function(elt){jQuery(elt).hide();},post:function(elt){if(self.active_annotation){djangosherd.assetview.clipform.html.push('clipform-display',{asset:{}});djangosherd.assetview.setState(self.active_annotation.annotation);djangosherd.assetview.clipform.setState(self.active_annotation.annotation,{'mode':'copy'});jQuery(elt).fadeIn();}}});});return false;};this.saveAnnotation=function(saveButton){jQuery(saveButton).attr("disabled","disabled").attr("value","Saving...").addClass("saving");var frm=document.forms['edit-annotation-form'];var obj=djangosherd.assetview.clipform.getState();if(_propertyCount(obj)>0){djangosherd.assetview.clipform.storage.update(obj,true);}else{obj=djangosherd.assetview.getState();if(_propertyCount(obj)>0){djangosherd.assetview.clipform.storage.update(obj,true);}}
var tag_field=frm.elements['annotation-tags'];if(tag_field){var tags=tag_field.value.split(',');for(var i=0;i<tags.length;i++){if(tags[i].trim().length>25){alert('The '+tags[i]+' is too long. Tags should be less than 25 characters. '+'And, be sure to separate your tags with commas.');return;}}}
if(frm.elements['annotation-title'].value===''){alert('Please specify a selection title');jQuery(saveButton).removeAttr("disabled");jQuery(saveButton).removeClass("saving");jQuery(saveButton).attr("value","Save");return;}
var url,creating;if(frm.elements['annotation-id']){url=MediaThread.urls['annotation-edit'](self.active_asset.id,frm.elements['annotation-id'].value);creating=false;}else{url=MediaThread.urls['annotation-create'](self.active_asset.id);creating=true;}
jQuery.ajax({type:'POST',url:url,data:jQuery(frm).serialize(),dataType:'json',cache:false,success:function(json,textStatus,jqXHR){djangosherd.storage.get({id:json.asset.id,type:'asset',url:MediaThread.urls['asset-json'](json.asset.id,true)},false,function(asset_full){if(creating){jQuery(window).trigger("annotation.on_create",[]);}else{jQuery(window).trigger("annotation.on_save",[]);}
self.asset_full_json=asset_full;var theAsset;for(var key in asset_full.assets){if(asset_full.assets.hasOwnProperty(key)){theAsset=asset_full.assets[key];break;}}
self.active_asset=theAsset;self.active_asset_annotations=asset_full.annotations;jQuery(saveButton).removeAttr("disabled");jQuery(saveButton).removeClass("saving");jQuery(saveButton).attr("value","Save");jQuery("#asset-details-annotations-current").fadeOut(function(){jQuery("#asset-details-annotations-current").hide();self._update({'annotation_id':json.annotation.id,'editing':false},"annotation-current");self.updateAnnotationList();self._addHistory(false);jQuery("#asset-global-annotation, #annotations-organized").fadeIn();window.onbeforeunload=null;});});}});};this._addHistory=function(replace){if(self.update_history===false){return;}
if(window.history.pushState){var action=replace?window.history.replaceState:window.history.pushState;var currentState={asset_id:((self.active_asset)?self.active_asset.id:self.config.asset_id)};if(self.active_annotation){currentState.annotation_id=self.active_annotation.id;action.apply(window.history,[currentState,self.active_annotation.title,"/asset/"+currentState.asset_id+"/annotations/"+self.active_annotation.id+"/"]);}else{action.apply(window.history,[currentState,self.active_asset.title,"/asset/"+self.active_asset.id+"/"]);}}else if(!replace){if(self.active_annotation){window.location.hash="annotation_id="+self.active_annotation.id;}else{window.location.hash='';}}};this._update=function(config,template_label){self.active_annotation=null;self.xywh=null;var context={'asset-current':self.active_asset};if(config.annotation_id){var annotation_id=parseInt(config.annotation_id,10);for(var i=0;i<self.active_asset_annotations.length;i++){var ann=self.active_asset_annotations[i];if(ann.id===annotation_id){self.active_annotation=ann;break;}}
if(self.active_annotation){context.annotation=self.active_annotation;if(self.config.edit_state==="annotation.edit"){context.annotation.editing=true;}else{context.annotation.editing=config.editing;}}}else if(config.xywh){self.xywh=config.xywh;context.annotation={'editing':true,'metadata':{'author':{'id':MediaThread.current_user},'author_name':MediaThread.user_full_name}};}else if(self.config.edit_state==="annotation.create"){context.annotation={'editing':true,'metadata':{'author':{'id':MediaThread.current_user},'author_name':MediaThread.user_full_name}};}else if(self.active_asset&&(self.active_asset.user_analysis===undefined||self.active_asset.user_analysis<1)){context.show_help=self.user_settings.help_item_detail_view;}
context.show_help_checked=!self.user_settings.help_item_detail_view;if(context.annotation){context.annotation.showCancel=self.active_asset_annotations.length>1;}
Mustache.update(template_label,context,{pre:function(elt){jQuery(elt).hide();},post:function(elt){self.edit_state=null;djangosherd.assetview.clipform.html.push('clipform-display',{asset:{}});Mustache.update("asset-view-header",context);Mustache.update("asset-global-annotation",context);Mustache.update("asset-references",context);if(template_label==="asset-view-details"){Mustache.update("asset-sources",context);}
if(self.active_annotation){djangosherd.assetview.setState(self.active_annotation.annotation);}else if(self.xywh){djangosherd.assetview.setState(self.xywh);}else{djangosherd.assetview.setState();}
jQuery(elt).fadeIn("slow",function(){if(self.active_annotation){djangosherd.assetview.clipform.setState(self.active_annotation.annotation,{'mode':context.annotation.editing?'edit':'browse','tool_play':jQuery('#annotation-body-'+self.active_annotation.id+' input.videoplay')[0]});}else if(self.xywh){if(djangosherd.assetview.clipform){djangosherd.assetview.clipform.setState(self.xywh,{'mode':'create'});}}else{djangosherd.assetview.clipform.setState({'start':0,'end':0},{'mode':context.annotation&&context.annotation.editing?'create':'browse'});}
if(self.view_callback){self.view_callback();}});}});};})();})();var AssetPanelHandler=function(el,parent,panel,space_owner){var self=this;self.el=el;self.panel=panel;self.parentContainer=parent;self.space_owner=space_owner;djangosherd.storage.json_update(panel.context);jQuery(self.el).find("div.tabs").tabs();jQuery(window).resize(function(){self.resize();});jQuery(window).bind('asset.on_delete',{'self':self},function(event,asset_id){event.data.self.onDeleteItem(asset_id);});jQuery(window).bind('asset.edit',{'self':self},self.dialog);jQuery(window).bind('annotation.create',{'self':self},self.dialog);jQuery(window).bind('annotation.edit',{'self':self},self.dialog);jQuery(window).bind('annotation.on_cancel',{'self':self},self.closeDialog);jQuery(window).bind('annotation.on_save',{'self':self},self.closeDialog);jQuery(window).bind('annotation.on_create',{'self':self},self.closeDialog);self.citationView=new CitationView();self.citationView.init({'default_target':"asset-workspace-videoclipbox",'presentation':"medium",'clipform':true,'autoplay':false,'winHeight':function(){if(self.dialogWindow){return 450;}else{var elt=jQuery(self.el).find("div.asset-view-published")[0];return jQuery(elt).height()-
(jQuery(elt).find("div.annotation-title").height()+jQuery(elt).find("div.asset-title").height()+15);}}});if(self.panel.show_collection){self.collectionList=new CollectionList({'parent':self.el,'template':'gallery','template_label':"media_gallery",'create_annotation_thumbs':false,'create_asset_thumbs':true,'space_owner':self.space_owner,'view_callback':function(){jQuery(self.el).find("a.asset-title-link").bind("click",{self:self},self.onClickAssetTitle);jQuery(self.el).find("a.edit-asset-inplace").bind("click",{self:self},self.editItem);var container=jQuery(self.el).find('div.asset-table')[0];jQuery(container).masonry({itemSelector:'.gallery-item',columnWidth:25});jQuery(window).trigger("resize");}});}
if(self.panel.current_asset){self.showAsset(self.panel.current_asset,self.panel.current_annotation,true);}
jQuery(window).trigger("resize");};AssetPanelHandler.prototype.closeDialog=function(event){var self=event.data.self;if(self.dialogWindow){jQuery(self.dialogWindow).dialog("close");}};AssetPanelHandler.prototype.dialog=function(event,assetId,annotationId){var self=event.data.self;var title="Edit Item";if(event.type==="annotation"){if(event.namespace==="create"){title="Create Selection";}else{title="Edit Selection";}}
var dlg=jQuery("#asset-workspace-panel-container")[0];var elt=jQuery(dlg).find("div.asset-view-tabs").hide();self.dialogWindow=jQuery(dlg).dialog({open:function(){self.dialogWindow=true;self.citationView.openCitationById(null,assetId,annotationId);AnnotationList.init({"asset_id":assetId,"annotation_id":annotationId,"edit_state":event.type+"."+event.namespace,"update_history":false,"view_callback":function(){if(self.dialogWindow){jQuery(elt).fadeIn("slow");}}});},close:function(){self.dialogWindow=null;},title:title,draggable:true,resizable:false,modal:true,width:825,height:520,position:"top",zIndex:10000});return false;};AssetPanelHandler.prototype.showAsset=function(asset_id,annotation_id,displayNow){var self=this;self.current_asset=parseInt(asset_id,10);if(displayNow){jQuery("div.ajaxloader").hide();jQuery(self.el).find('td.panel-container.collection').removeClass('maximized').addClass('minimized');jQuery(self.el).find('td.pantab-container').removeClass('maximized').addClass('minimized');jQuery(self.el).find('div.pantab.collection').removeClass('maximized').addClass('minimized');jQuery(self.el).find('td.panel-container.asset').removeClass("closed").addClass("open");jQuery(self.el).find('td.panel-container.asset').show();jQuery(self.el).find('td.panel-container.asset-details').show();self.citationView.openCitationById(null,asset_id,annotation_id);}
jQuery(self.el).find("a.filterbyclasstag").unbind();AnnotationList.init({"asset_id":asset_id,"annotation_id":annotation_id,"update_history":self.panel.update_history,"view_callback":function(){jQuery(self.el).find("a.filterbyclasstag").bind("click",{self:self},self.onFilterByClassTag);jQuery(self.el).find("div.tabs").fadeIn("fast",function(){PanelManager.verifyLayout(self.el);jQuery(window).trigger("resize");});}});};AssetPanelHandler.prototype.resize=function(){var self=this;var visible=getVisibleContentHeight();visible-=18;var collectionHeight=visible-jQuery(self.el).find("div.filter-widget").height();jQuery(self.el).find('div.collection-assets').css('height',collectionHeight+"px");jQuery(self.el).find('div.asset-view-container').css('height',(visible)+"px");visible-=jQuery("div.asset-view-title").outerHeight();jQuery(self.el).find('div.asset-view-published').css('height',(visible)+"px");jQuery(self.el).find('div.asset-view-tabs').css('height',(visible)+"px");visible-=jQuery('ul.ui-tabs-nav').outerHeight()+2;jQuery(self.el).find('.ui-tabs-panel').css('height',(visible)+"px");visible-=jQuery("div#asset-global-annotation").outerHeight();jQuery(self.el).find('div#annotations-organized').css('height',(visible-25)+"px");visible-=jQuery("div#annotations-organized h2").outerHeight()+
jQuery("div#annotations-organized div.ui-widget-header").outerHeight()+50;jQuery(self.el).find('ul#asset-details-annotations-list').css('height',(visible)+"px");jQuery("div.accordion").accordion("resize");};AssetPanelHandler.prototype.onClickAssetTitle=function(evt){var self=evt.data.self;var srcElement=evt.srcElement||evt.target||evt.originalTarget;var bits=srcElement.href.split('/');self.showAsset(bits[bits.length-2],null,true);return false;};AssetPanelHandler.prototype.editItem=function(evt){var self=evt.data.self;var srcElement=evt.srcElement||evt.target||evt.originalTarget;var bits=srcElement.parentNode.href.split('/');self.showAsset(bits[bits.length-2],null,true);return false;};AssetPanelHandler.prototype.onDeleteItem=function(asset_id){var self=this;if(typeof asset_id==="string"){asset_id=parseInt(asset_id,10);}
if(asset_id===self.current_asset){AnnotationList.refresh({'asset_id':asset_id});}};AssetPanelHandler.prototype.onFilterByClassTag=function(evt){var self=evt.data.self;var srcElement=evt.srcElement||evt.target||evt.originalTarget;var bits=srcElement.href.split("/");self.collectionList.filterByClassTag(bits[bits.length-1]);return false;};var ProjectList=function(config){var self=this;self.template_label=config.template_label;self.parent=config.parent;self.switcher_context={};jQuery.ajax({url:'/site_media/templates/'+config.template+'.mustache?nocache=v2',dataType:'text',cache:false,success:function(text){MediaThread.templates[config.template]=Mustache.template(config.template,text);self.refresh(config);}});jQuery(window).bind('projectlist.refresh',{'self':self},function(event){var self=event.data.self;self.refresh(config);});return this;};ProjectList.prototype.createAssignmentResponse=function(evt){var self=this;var srcElement=evt.srcElement||evt.target||evt.originalTarget;if(!jQuery(srcElement).is("a")){srcElement=jQuery(srcElement).parent();}
var params={'parent':jQuery(srcElement).data("id")};jQuery.ajax({type:'POST',url:MediaThread.urls['project-create'](),dataType:'json',data:params,success:function(json){window.location=json.context.project.url;}});};ProjectList.prototype.deleteAssignmentResponse=function(evt){var self=this;var srcElement=evt.srcElement||evt.target||evt.originalTarget;var link=jQuery(srcElement).parent()[0];var data_id=jQuery(link).data("id");return ajaxDelete(link,data_id,{object_type:'assignment response',success:function(){self.refresh(self.config);}});};ProjectList.prototype.refresh=function(config){var self=this;var url;if(config.view==='all'||!config.space_owner){url=MediaThread.urls['all-projects']();}else{url=MediaThread.urls['your-projects'](config.space_owner);}
jQuery("a.linkRespond").unbind("click");jQuery("a.btnRespond").unbind("click");jQuery("a.btnDeleteResponse").unbind("click");jQuery.ajax({url:url,dataType:'json',cache:false,success:function(the_records){self.update(the_records);jQuery("a.btnRespond").bind("click",function(evt){self.createAssignmentResponse(evt);});jQuery("a.linkRespond").bind("click",function(evt){self.createAssignmentResponse(evt);});jQuery("a.btnDeleteResponse").bind("click",function(evt){self.deleteAssignmentResponse(evt);});}});};ProjectList.prototype.selectOwner=function(username){var self=this;var url=username?MediaThread.urls['your-projects'](username):MediaThread.urls['all-projects']();jQuery.ajax({type:'GET',url:url,dataType:'json',error:function(){alert('There was an error retrieving the project list.');},success:function(the_records){self.update(the_records);}});return false;};ProjectList.prototype.getShowingAllItems=function(json){return!json.hasOwnProperty('space_owner');};ProjectList.prototype.getSpaceUrl=function(active_tag,active_modified){var self=this;if(self.getShowingAllItems(self.current_records)){return MediaThread.urls['all-projects']();}else{return MediaThread.urls['your-projects'](self.current_records.space_owner.username);}};ProjectList.prototype.updateSwitcher=function(){var self=this;self.switcher_context.display_switcher_extras=!self.switcher_context.showing_my_items;Mustache.update("switcher_collection_chooser",self.switcher_context,{parent:self.parent});jQuery(self.parent).find("a.switcher-choice.owner").unbind('click').click(function(evt){var srcElement=evt.srcElement||evt.target||evt.originalTarget;var bits=srcElement.href.split("/");var username=bits[bits.length-1];if(username==="all-class-members"){username=null;}
return self.selectOwner(username);});};ProjectList.prototype.update=function(the_records){var self=this;self.switcher_context.owners=the_records.course.group.user_set;self.switcher_context.space_viewer=the_records.space_viewer;self.switcher_context.selected_view=self.selected_view;if(self.getShowingAllItems(the_records)){self.switcher_context.selected_label="All Class Members";self.switcher_context.showing_all_items=true;self.switcher_context.showing_my_items=false;the_records.showing_all_items=true;}else if(the_records.space_owner.username===the_records.space_viewer.username){self.switcher_context.selected_label="Me";self.switcher_context.showing_my_items=true;self.switcher_context.showing_all_items=false;the_records.showing_my_items=true;}else{self.switcher_context.showing_my_items=false;self.switcher_context.showing_all_items=false;self.switcher_context.selected_label=the_records.space_owner.public_name;}
self.current_records=the_records;var n=_propertyCount(the_records.active_filters);if(n>0){the_records.active_filter_count=n;}
Mustache.update(self.template_label,the_records,{parent:self.parent,pre:function(elt){jQuery(elt).hide();},post:function(elt){self.updateSwitcher();jQuery(elt).fadeIn("slow");}});};var ProjectPanelHandler=function(el,parent,panel,space_owner){var self=this;self.el=el;self.panel=panel;self.projectModified=false;self.parentContainer=parent;self.space_owner=space_owner;self.tiny_mce_settings=tiny_mce_settings;djangosherd.storage.json_update(panel.context);if(panel.context.can_edit){var select=jQuery(self.el).find("select[name='participants']")[0];jQuery(select).addClass("selectfilter");SelectFilter.init("id_participants_"+panel.context.project.id,"participants",0,"/media/");var assignment_elt=jQuery(self.el).find("label[for='id_publish_2']").parent();if(assignment_elt.length>0){jQuery(self.el).find('div.due-date').appendTo(assignment_elt);}}
self.project_type=panel.context.project.project_type;self.essaySpace=jQuery(self.el).find(".essay-space")[0];jQuery(window).bind('tinymce_init_instance',function(event,instance,param2){self.onTinyMCEInitialize(instance);});jQuery(window).resize(function(){self.resize();});self._bind(self.el,"td.panel-container","panel_state_change",function(){self.onClosePanel(jQuery(this).hasClass("subpanel"));});self._bind(self.el,"input.project-savebutton","click",function(evt){return self.showSaveOptions(evt);});self._bind(self.el,"a.project-visibility-link","click",function(evt){jQuery(self.el).find("input.project-savebutton").click();});self._bind(self.el,"input.project-previewbutton","click",function(evt){return self.preview(evt);});self._bind(self.el,"input.participants_toggle","click",function(evt){return self.showParticipantList(evt);});self._bind(self.el,"input.project-revisionbutton","click",function(evt){self.showRevisions(evt);});self._bind(self.el,"input.project-responsesbutton","click",function(evt){self.showResponses(evt);});self._bind(self.el,"input.project-my-responses","click",function(evt){self.showMyResponses(evt);});self._bind(self.el,"input.project-my-response","click",function(evt){self.showMyResponse(evt);});self._bind(self.el,"input.project-create-assignment-response","click",function(evt){self.createAssignmentResponse(evt);});self._bind(self.el,"input.project-create-instructor-feedback","click",function(evt){self.createInstructorFeedback(evt);});self._bind(self.el,"input.project-title",'keypress',function(evt){self.setDirty(true);});self.citationView=new CitationView();self.citationView.init({'default_target':panel.context.project.id+"-videoclipbox",'onPrepareCitation':self.onPrepareCitation,'presentation':"medium",'clipform':true,'winHeight':function(){var elt=jQuery(self.el).find("div.asset-view-published")[0];return jQuery(elt).height()-
(jQuery(elt).find("div.annotation-title").height()+jQuery(elt).find("div.asset-title").height()+15);}});self.citationView.decorateLinks(self.essaySpace.id);if(panel.context.can_edit){tinyMCE.settings=self.tiny_mce_settings;tinyMCE.execCommand("mceAddControl",false,panel.context.project.id+"-project-content");}
self.render();};ProjectPanelHandler.prototype.onTinyMCEInitialize=function(instance){var self=this;if(instance&&instance.id===self.panel.context.project.id+"-project-content"&&!self.tinyMCE){self.tinyMCE=instance;jQuery('#'+self.panel.context.project.id+'-project-content_tbl').css('width',"100%");jQuery(window).bind('beforeunload',function(){return self.beforeUnload();});self.collectionList=new CollectionList({'parent':self.el,'template':'collection','template_label':"collection_table",'create_annotation_thumbs':true,'space_owner':self.space_owner,'citable':true,'view_callback':function(){var newAssets=self.collectionList.getAssets();self.tinyMCE.plugins.citation.decorateCitationAdders(newAssets);jQuery(window).trigger("resize");}});if(self.panel.context.editing){self.tinyMCE.show();var title=jQuery(self.el).find("input.project-title");title.focus();}
jQuery(self.el).find(".participants_toggle").removeAttr("disabled");self.render();}};ProjectPanelHandler.prototype.resize=function(){var self=this;var visible=getVisibleContentHeight();visible-=jQuery(self.el).find(".project-visibility-row").height();visible-=jQuery(self.el).find(".project-toolbar-row").height();visible-=jQuery(self.el).find(".project-participant-row").height();visible-=jQuery("#footer").height();if(self.tinyMCE){var editorHeight=visible;jQuery(self.el).find("table.mceLayout").css('height',(editorHeight)+"px");jQuery(self.el).find("iframe").css('height',(editorHeight)+"px");}
jQuery(self.el).find("div.essay-space").css('height',(visible+20)+"px");jQuery(self.el).find('div.asset-view-published').css('height',(visible+30)+"px");visible-=jQuery(self.el).find("div.filter-widget").outerHeight();jQuery(self.el).find('div.collection-assets').css('height',visible+"px");jQuery(self.el).find('tr.project-content-row').css('height',(visible)+"px");jQuery(self.el).find('tr.project-content-row').children('td.panhandle-stripe').css('height',(visible-10)+"px");};ProjectPanelHandler.prototype.render=function(){var self=this;var preview=self.isPreview();var open=self.isSubpanelOpen();if(preview&&open){jQuery(self.el).find(".panel-content").removeClass("fluid").addClass("fixed");jQuery(self.el).find("td.panel-container.collection").removeClass("fixed").addClass("fluid");}else{jQuery(self.el).find(".panel-content").removeClass("fixed").addClass("fluid");jQuery(self.el).find("td.panel-container.collection").removeClass("fluid").addClass("fixed");}
jQuery(window).trigger("resize");};ProjectPanelHandler.prototype.onClosePanel=function(isSubpanel){var self=this;if(self.tinyMCE){self.tinyMCE.plugins.editorwindow._closeWindow();}
self.render();};ProjectPanelHandler.prototype.onPrepareCitation=function(target){jQuery(target).parent().css("background","none");var a=jQuery(target).parents("td.panel-container.collection");if(a&&a.length){PanelManager.openSubPanel(a[0]);}};ProjectPanelHandler.prototype.createAssignmentResponse=function(evt){var self=this;PanelManager.closeSubPanel(self);var context={'url':MediaThread.urls['project-create'](),'params':{parent:self.panel.context.project.id}};if(jQuery(self.parentContainer).find("td.panel-container.composition").length>0){context.callback=function(json){window.location=json.context.project.url;};}
PanelManager.newPanel(context);var srcElement=evt.srcElement||evt.target||evt.originalTarget;jQuery(srcElement).remove();};ProjectPanelHandler.prototype.createInstructorFeedback=function(evt){var self=this;PanelManager.closeSubPanel(self);PanelManager.newPanel({'url':MediaThread.urls['discussion-create'](),'params':{'publish':'PrivateStudentAndFaculty','inherit':'true','app_label':'projects','model':'project','obj_pk':self.panel.context.project.id,'comment_html':jQuery(self.el).find("h1.project-title").html().trim()+": Instructor Feedback"}});var srcElement=evt.srcElement||evt.target||evt.originalTarget;jQuery(srcElement).remove();};ProjectPanelHandler.prototype.showParticipantList=function(evt){var self=this;var srcElement=evt.srcElement||evt.target||evt.originalTarget;var frm=srcElement.form;if(self.tinyMCE){self.tinyMCE.plugins.editorwindow._closeWindow();}
var element=jQuery(self.el).find(".participant_list")[0];jQuery(element).dialog({buttons:[{text:"Update",click:function(){jQuery(this).dialog("close");}}],beforeClose:function(event,ui){self._save=false;if(!self._validAuthors()){return false;}else{self.updateParticipantList();return true;}},draggable:true,resizable:false,modal:true,width:425,position:"top",zIndex:10000});jQuery(element).parent().appendTo(frm);return false;};ProjectPanelHandler.prototype.showRevisions=function(evt){var self=this;var srcElement=evt.srcElement||evt.target||evt.originalTarget;var frm=srcElement.form;if(self.tinyMCE){self.tinyMCE.plugins.editorwindow._closeWindow();}
var element=jQuery(self.el).find(".revision-list")[0];jQuery(element).dialog({buttons:[{text:"Cancel",click:function(){jQuery(this).dialog("close");}},{text:"View",click:function(){self._save=true;jQuery(this).dialog("close");}}],beforeClose:function(event,ui){if(self._save){self._save=false;var opts=jQuery(self.el).find("select[name='revisions'] option:selected");if(opts.length<1){alert("Please select a revision");return false;}else{var val=jQuery(opts[0]).val();window.open(val,'mediathread_project'+self.panel.context.project.id);}}
return true;},modal:true,width:425,height:245,position:"top",zIndex:10000});jQuery(element).parent().appendTo(frm);return false;};ProjectPanelHandler.prototype.showResponses=function(evt){var self=this;var srcElement=evt.srcElement||evt.target||evt.originalTarget;var frm=srcElement.form;if(self.tinyMCE){self.tinyMCE.plugins.editorwindow._closeWindow();}
var element=jQuery(self.el).find(".response-list")[0];jQuery(element).dialog({buttons:[{text:"Cancel",click:function(){jQuery(this).dialog("close");}},{text:"View Response",click:function(){self._save=true;jQuery(this).dialog("close");}}],beforeClose:function(event,ui){if(self._save){self._save=false;var opts=jQuery(self.el).find("select[name='responses'] option:selected");if(opts.length<1){alert("Please select a response");return false;}else{var val=jQuery(opts[0]).val();window.location=val;}}
return true;},modal:true,width:425,height:200,position:"top",zIndex:10000});jQuery(element).parent().appendTo(frm);return false;};ProjectPanelHandler.prototype.showMyResponses=function(evt){var self=this;var srcElement=evt.srcElement||evt.target||evt.originalTarget;var frm=srcElement.form;if(self.tinyMCE){self.tinyMCE.plugins.editorwindow._closeWindow();}
var element=jQuery(self.el).find(".my-response-list")[0];jQuery(element).dialog({buttons:[{text:"Cancel",click:function(){jQuery(this).dialog("close");}},{text:"View",click:function(){self._save=true;jQuery(this).dialog("close");}}],beforeClose:function(event,ui){if(self._save){self._save=false;var opts=jQuery(self.el).find("select[name='my-responses'] option:selected");if(opts.length<1){alert("Please select a response");return false;}else{var val=jQuery(opts[0]).val();window.location=val;}}
return true;},modal:true,width:425,height:200,position:"top",zIndex:10000});jQuery(element).parent().appendTo(frm);return false;};ProjectPanelHandler.prototype.showMyResponse=function(evt){var srcElement=evt.srcElement||evt.target||evt.originalTarget;window.location=jQuery(srcElement).data("url");};ProjectPanelHandler.prototype.updateParticipantList=function(evt){var self=this;var opts=jQuery(self.el).find("select[name='participants'] option");var old_list=jQuery(self.el).find('.participants_chosen').text().replace(/^\s*/,'').replace(/\s*$/,'').replace(/,\s+/g,',').split(',');var matches=old_list.length===opts.length;for(var i=0;i<opts.length&&matches;i++){matches=jQuery.inArray(opts[i].innerHTML,old_list)>=0;}
if(!matches){self.updateParticipantsLabel();self.setDirty(true);}
return false;};ProjectPanelHandler.prototype.updateParticipantsLabel=function(){var self=this;var opts=jQuery(self.el).find("select[name='participants'] option");var participant_list="";for(var i=0;i<opts.length;i++){if(participant_list.length>0){participant_list+=", ";}
participant_list+=opts[i].innerHTML;}
jQuery(self.el).find('.participants_chosen').html(participant_list);};ProjectPanelHandler.prototype.isPreview=function(){var self=this;return jQuery(self.essaySpace).css("display")==="block";};ProjectPanelHandler.prototype.isSubpanelOpen=function(){var self=this;return jQuery(self.el).find("td.panel-container.collection").hasClass("open");};ProjectPanelHandler.prototype.preview=function(evt){var self=this;self.citationView.unload();if(self.tinyMCE){self.tinyMCE.plugins.editorwindow._closeWindow();}
if(self.isPreview()){jQuery(self.essaySpace).hide();jQuery(self.el).find("td.panhandle-stripe div.label").html("Insert Selections");jQuery(self.el).find("input.project-previewbutton").attr("value","Preview");jQuery(self.el).find("div.asset-view-published").hide();jQuery(self.el).find("h1.project-title").hide();self.citationView.unload();jQuery(self.el).find("div.collection-materials").show();jQuery(self.el).find("input.project-title").show();jQuery(self.el).find("input.participants_toggle").show();jQuery(self.el).find("span.project-current-version").show();jQuery(self.el).find('table.panel-subcontainer tr td.panel-subcontainer-toolbar-column').addClass("editing");jQuery(self.el).find(".panel-content.fixed").removeClass("fixed").addClass("fluid");jQuery(self.el).find("td.panel-container.collection").removeClass("fluid").addClass("fixed");self.tinyMCE.show();}else{var isDirty=self.projectModified;self.tinyMCE.hide();self.tinyMCE.plugins.editorwindow._closeWindow();jQuery(self.el).find("h1.project-title").html(jQuery(self.el).find("input.project-title").val());jQuery(self.el).find("textarea.mceEditor").hide();jQuery(self.el).find("div.collection-materials").hide();jQuery(self.el).find("input.project-title").hide();jQuery(self.el).find("input.participants_toggle").hide();jQuery(self.el).find("span.project-current-version").hide();jQuery(self.el).find('table.panel-subcontainer tr td.panel-subcontainer-toolbar-column').removeClass("editing");if(jQuery(self.el).find("td.panel-container.collection").hasClass("open")){jQuery(self.el).find(".panel-content").removeClass("fluid").addClass("fixed");jQuery(self.el).find("td.panel-container.collection").removeClass("fixed").addClass("fluid");}
jQuery(self.essaySpace).html(tinyMCE.activeEditor.getContent());self.citationView.decorateLinks(self.essaySpace.id);jQuery(self.essaySpace).show();jQuery(self.el).find("td.panhandle-stripe div.label").html("View Inserted Selections");jQuery(self.el).find("input.project-previewbutton").attr("value","Edit");jQuery(self.el).find("div.asset-view-published").show();jQuery(self.el).find("h1.project-title").show();self.projectModified=isDirty;}
jQuery(window).trigger("resize");return false;};ProjectPanelHandler.prototype.showSaveOptions=function(evt){var self=this;if(!self._validTitle()||!self._validAuthors()){return false;}
var srcElement=evt.srcElement||evt.target||evt.originalTarget;var frm=srcElement.form;var element=jQuery(frm).find("div.save-publish-status")[0];jQuery(element).dialog({buttons:[{text:"Cancel",click:function(){jQuery(this).dialog("close");}},{text:"Save",click:function(){self._save=true;jQuery(this).dialog("close");}}],create:function(){jQuery('#id_due_date').datepicker({minDate:0,dateFormat:'mm/dd/yy',beforeShow:function(input,inst){inst.dpDiv.css({top:(input.offsetHeight)+'px'});}});jQuery("input[name=publish]").bind('click',function(){});},beforeClose:function(event,ui){if(self._save){self.saveProject(frm);}
self._save=false;return true;},draggable:false,resizable:false,modal:true,width:430,position:"top",zIndex:10000});jQuery(element).parent().appendTo(frm);return false;};ProjectPanelHandler.prototype.saveProject=function(frm){var self=this;tinyMCE.activeEditor.save();if(!self._validTitle()||!self._validAuthors()){return false;}
jQuery(self.el).find("select[name='participants'] option").attr("selected","selected");var data=jQuery(frm).serializeArray();data=data.concat(jQuery(document.forms.editparticipants).serializeArray());var saveButton=jQuery(self.el).find(".project-savebutton").get(0);jQuery(saveButton).attr("disabled","disabled").attr("value","Saving...").addClass("saving");jQuery.ajax({type:'POST',url:frm.action,data:data,dataType:'json',error:function(){jQuery(saveButton).removeAttr("disabled").attr("value","Save").removeClass("saving");alert('There was an error saving your project.');},success:function(json,textStatus,xhr){if(json.status==='error'){alert(json.msg);}else{var lastVersionPublic=jQuery(self.el).find(".last-version-public").get(0);if(json.revision.public_url){jQuery(lastVersionPublic).attr("href",json.revision.public_url);jQuery(lastVersionPublic).show();}else{jQuery(lastVersionPublic).attr("href","");jQuery(lastVersionPublic).hide();}
if(json.is_assignment){jQuery(self.el).removeClass("composition").addClass("assignment");jQuery(self.el).find(".composition").removeClass("composition").addClass("assignment");jQuery(self.el).next(".pantab-container").find(".composition").removeClass("composition").addClass("assignment");jQuery(self.el).prev().removeClass("composition").addClass("assignment");jQuery(self.el).prev().find("div.label").html("assignment");jQuery(self.el).prev().prev().find(".composition").removeClass("composition").addClass("assignment");}else{jQuery(self.el).removeClass("assignment").addClass("composition");jQuery(self.el).find(".assignment").removeClass("assignment").addClass("composition");jQuery(self.el).next(".pantab-container").find(".assignment").removeClass("assignment").addClass("composition");jQuery(self.el).prev().removeClass("assignment").addClass("composition");jQuery(self.el).prev().find("div.label").html("composition");jQuery(self.el).prev().prev().find(".assignment").removeClass("assignment").addClass("composition");}
jQuery(self.el).find('.project-visibility-description').html(json.revision.visibility);if(json.revision.due_date){jQuery(self.el).find('.project-due-date').html("Due "+json.revision.due_date);}else{jQuery(self.el).find('.project-due-date').html("");}
self.setDirty(false);self.revision=json.revision;if("title"in json){document.title="Mediathread "+json.title;}}
jQuery(saveButton).removeAttr("disabled").removeClass("saving",1200,function(){jQuery(this).attr("value","Save");});}});return true;};ProjectPanelHandler.prototype.setDirty=function(isDirty){var self=this;self.projectModified=isDirty;if(!isDirty&&self.tinyMCE){self.tinyMCE.isNotDirty=1;}};ProjectPanelHandler.prototype.beforeUnload=function(){var self=this;var msg=null;if(self.projectModified||self.tinyMCE.isDirty()||(self.tinyMCE.editorId===tinyMCE.activeEditor.editorId&&tinyMCE.activeEditor.isDirty())){msg="Changes to your project have not been saved.";}else{var title=jQuery(self.el).find("input[name=title]");if(title&&title.length>0){var value=jQuery(title[0]).val();if(!value||value.length<1){msg="Please specify a project title.";}else if(value==="Untitled"){msg='Please update your "Untitled" project title.';}}}
if(msg){PanelManager.openPanel(self.el);return msg;}};ProjectPanelHandler.prototype._bind=function(parent,elementSelector,event,handler){var elements=jQuery(parent).find(elementSelector);if(elements.length){jQuery(elements[0]).bind(event,handler);return true;}else{return false;}};ProjectPanelHandler.prototype._validAuthors=function(){var self=this;var options=jQuery(self.el).find("select[name='participants'] option");if(options.length<1){alert("This project has no authors. Please select at least one author.");return false;}else{return true;}};ProjectPanelHandler.prototype._validTitle=function(){var self=this;var title=jQuery(self.el).find("input.project-title");var value=title.val();if(!value||value.length<1){alert("Please specify a project title.");title.focus();return false;}else if(value==="Untitled"){alert('Please update your "Untitled" project title.');title.focus();return false;}else{return true;}};var DiscussionPanelHandler=function(el,parent,panel,space_owner){var self=this;self.el=el;self.panel=panel;self.parentContainer=parent;self.space_owner=space_owner;self.form=jQuery(self.el).find("form.threaded_comments_form")[0];self.max_comment_length=parseInt(self.form.getAttribute('data-maxlength'),10);djangosherd.storage.json_update(panel.context);jQuery(window).resize(function(){self.resize();});jQuery(window).bind('tinymce_init_instance',function(event,instance,param2){self.onTinyMCEInitialize(instance);});self._bind(self.el,"td.panel-container","panel_state_change",function(){self.onClosePanel(jQuery(this).hasClass("subpanel"));});self.citationView=new CitationView();self.citationView.init({'default_target':panel.context.discussion.id+"-videoclipbox",'onPrepareCitation':self.onPrepareCitation,'presentation':"medium",'clipform':true,'winHeight':function(){var elt=jQuery(self.el).find("div.asset-view-published")[0];return jQuery(elt).height()-
(jQuery(elt).find("div.annotation-title").height()+
jQuery(elt).find("div.asset-title").height()+
jQuery(elt).find("div.discussion-toolbar-row").height()+15);}});self.citationView.decorateLinks(self.el.id);jQuery(this.form).bind('submit',{self:this},this.submit);jQuery("input.cancel").bind('click',{self:this},this.cancel);if(jQuery(this.form.elements.name).attr("value")===""){jQuery(this.form.elements.name).attr("value",this.space_owner);}
if(jQuery(this.form.elements.email).attr("value")===""){jQuery(this.form.elements.email).attr("value","null@example.com");}
jQuery('span.respond_prompt',self.el).click(function(evt){self.open_respond(evt);});jQuery('span.edit_prompt',self.el).click(function(evt){self.open_edit(evt);});if(self.panel.context.discussion.thread.length===1&&self.panel.context.discussion.thread[0].author_username===self.space_owner&&self.panel.context.discussion.thread[0].content.length<1){var elt=jQuery(self.el).find("span.edit_prompt")[0];jQuery(elt).trigger("click");}else{self.hide_comment_form(false);}
jQuery(window).trigger("resize");};DiscussionPanelHandler.prototype.isEditing=function(){var self=this;return jQuery(self.form).css("display")==="block";};DiscussionPanelHandler.prototype.isSubpanelOpen=function(){var self=this;return jQuery(self.el).find("td.panel-container.collection").hasClass("open");};DiscussionPanelHandler.prototype.onTinyMCEInitialize=function(instance){var self=this;if(instance&&instance.id==="id_comment"&&!self.tinyMCE){self.tinyMCE=instance;jQuery('#id_comment_tbl').css('width',"100%");if(jQuery("#id_title").is(":visible")){jQuery("#id_title").focus();}else{self.tinyMCE.focus();}
self.collectionList=new CollectionList({'parent':self.el,'template':'collection','template_label':"collection_table",'create_annotation_thumbs':true,'space_owner':self.space_owner,'citable':true,'view_callback':function(){var newAssets=self.collectionList.getAssets();self.tinyMCE.plugins.citation.decorateCitationAdders(newAssets);}});self.resize();}};DiscussionPanelHandler.prototype.resize=function(){var self=this;var visible=getVisibleContentHeight();jQuery(self.el).find('tr td.panel-container div.panel').css('height',(visible)+"px");visible-=jQuery(self.el).find(".discussion-toolbar-row").height();visible-=jQuery(self.el).find(".discussion-participant-row").height();visible-=80;if(self.tinyMCE){var threads=jQuery('li.comment-thread');var editorHeight=visible;if(threads.length===0){editorHeight-=35;}else{editorHeight=150;}
jQuery(self.el).find("table.mceLayout").css('height',(editorHeight)+"px");jQuery(self.el).find("iframe").css('height',(editorHeight)+"px");}
visible+=45;jQuery(self.el).find('div.threadedcomments-container').css('height',(visible+30)+"px");jQuery(self.el).find('div.collection-assets').css('height',(visible-50)+"px");jQuery(self.el).find('div.asset-view-published').css('height',(visible+30)+"px");jQuery(self.el).find('tr.discussion-content-row').css('height',(visible)+"px");jQuery(self.el).find('tr.discussion-content-row').children('td.panhandle-stripe').css('height',(visible-10)+"px");};DiscussionPanelHandler.prototype.onClosePanel=function(){var self=this;if(self.tinyMCE){self.tinyMCE.plugins.editorwindow._closeWindow();}
self.render();};DiscussionPanelHandler.prototype.render=function(){var self=this;if(!self.isEditing()&&self.isSubpanelOpen()){jQuery(self.el).find(".panel-content").removeClass("fluid").addClass("fixed");jQuery(self.el).find("td.panel-container.collection").removeClass("fixed").addClass("fluid");}else{jQuery(self.el).find(".panel-content").removeClass("fixed").addClass("fluid");jQuery(self.el).find("td.panel-container.collection").removeClass("fluid").addClass("fixed");}
jQuery(window).trigger("resize");};DiscussionPanelHandler.prototype.onPrepareCitation=function(target){jQuery(target).parent().css("background","none");var a=jQuery(target).parents("td.panel-container.collection");if(a&&a.length){PanelManager.openSubPanel(a[0]);}};DiscussionPanelHandler.prototype.set_comment_content=function(content){var self=this;content=content||{comment:'<p></p>'};self.form.elements.comment.value=content.comment;self.form.elements.title.value=content.title||'';try{if(self.tinyMCE){self.tinyMCE.setContent(content.comment);}}catch(e){}};DiscussionPanelHandler.prototype.open_respond=function(evt){var self=this;jQuery(self.form).addClass("response");jQuery(self.form).children("h3").show();jQuery(self.form).find("input.cancel").show();var elt=evt.srcElement||evt.target||evt.originalTarget;self.form.elements.parent.value=elt.getAttribute("data-comment");self.form.elements['edit-id'].value='';self.mode='post';var li=jQuery(elt).parents("li.comment-thread")[0];jQuery("div.respond_to_comment_form_div").hide();var comment_div=jQuery(li).children("div.comment")[0];self.open_comment_form(comment_div,true);};DiscussionPanelHandler.prototype.open_edit=function(evt,focus){var self=this;jQuery(self.form).removeClass("response");jQuery(self.form).children("h3").hide();if(evt===undefined){self.form.elements.parent.value='';self.open_comment_form();}else{var elt=evt.srcElement||evt.target||evt.originalTarget;var id=elt.getAttribute("data-comment");self.form.elements['edit-id'].value=id;self.set_comment_content(self.read({html:jQuery('#comment-'+id).get(0)}));var li=jQuery(elt).parents("li.comment-thread")[0];var myText=jQuery(li).find("div.threaded_comment_text")[0];jQuery(myText).hide();jQuery("div.respond_to_comment_form_div").hide();elt=jQuery(li).find("div.threaded_comment_header")[0];jQuery(self.form).find("input.cancel").show();self.open_comment_form(elt);if(self.panel.can_edit_title&&self.panel.root_comment_id.toString()===self.form.elements['edit-id'].value){jQuery(self.form.elements.title).show();}}};DiscussionPanelHandler.prototype.open_comment_form=function(insertAfter,scroll){var self=this;jQuery(self.el).find("div.threaded_comment_header").addClass("opacity_fiftypercent");jQuery(self.el).find("div.threaded_comment_text").addClass("opacity_fiftypercent");jQuery(self.el).find("div.threaded_comment_text").find("a.materialCitation").addClass("disabled");if(insertAfter){self.tinyMCE=null;tinyMCE.execCommand("mceRemoveControl",false,"id_comment");jQuery(self.form).insertAfter(insertAfter);tinyMCE.settings.theme_advanced_statusbar_location="bottom";tinyMCE.settings.theme_advanced_resize_vertical=true;tinyMCE.execCommand("mceAddControl",false,"id_comment");}
jQuery(self.form).show('fast',function(){if(scroll){var elt=jQuery(self.el).find("div.threadedcomments-container")[0];jQuery(elt).animate({scrollTop:jQuery(elt).scrollTop()+jQuery(self.form).parent().position().top+20},500);}});self.citationView.unload();jQuery(self.el).find("div.asset-view-published").hide();jQuery(self.el).find("td.panhandle-stripe div.label").html("Insert Selections");jQuery(self.el).find("div.collection-materials").show();self.render();};DiscussionPanelHandler.prototype.hide_comment_form=function(){var self=this;jQuery(self.el).find("div.threaded_comment_header").removeClass("opacity_fiftypercent");jQuery(self.el).find("div.threaded_comment_text").removeClass("opacity_fiftypercent");jQuery(self.el).find("div.threaded_comment_text").find("a.materialCitation").removeClass("disabled");if(self.tinyMCE){self.tinyMCE.plugins.editorwindow._closeWindow();}
jQuery(self.form).hide('fast',function(){jQuery(self.form.elements.title).hide();jQuery(self.el).find("div.collection-materials").hide();jQuery(self.el).find("td.panhandle-stripe div.label").html("View Inserted Selections");jQuery(self.el).find("div.asset-view-published").show();self.render();});};DiscussionPanelHandler.prototype._bind=function(parent,elementSelector,event,handler){var elements=jQuery(parent).find(elementSelector);if(elements.length){jQuery(elements[0]).bind(event,handler);return true;}else{return false;}};DiscussionPanelHandler.prototype.cancel=function(evt){var self=evt.data.self;var elt=evt.srcElement||evt.target||evt.originalTarget;self.set_comment_content();self.hide_comment_form(true);jQuery("div.threaded_comment_text").show();jQuery("div.respond_to_comment_form_div").show();};DiscussionPanelHandler.prototype.submit=function(evt){var self=evt.data.self;self.tinyMCE.save();evt.preventDefault();if(self.max_comment_length&&self.form.elements.comment.value.length>self.max_comment_length){alert('Your comment is above the allowed maximum length of '+
self.max_comment_length+' characters (which includes HTML).  Your comment is '+
self.form.elements.comment.value.length+' characters long.');return;}
var frm=jQuery(self.form);var form_val_array=frm.serializeArray();var info={'edit-id':self.form.elements['edit-id'].value};info.mode=((info['edit-id']==='')?'post':'update');switch(info.mode){case'update':info.url=MediaThread.urls['comment-edit'](info['edit-id']);break;case'post':info.url=MediaThread.urls['comment-create']();break;}
jQuery.ajax({type:'POST',url:info.url,data:form_val_array,dataType:'html',success:self.oncomplete,error:self.onfail,context:{'self':self,'form_val_array':form_val_array,'info':info}});};DiscussionPanelHandler.prototype.oncomplete=function(responseText,textStatus,xhr){var self=this.self;var form_vals={};for(var i=0;i<this.form_val_array.length;i++){form_vals[this.form_val_array[i].name]=this.form_val_array[i].value;}
var res=self.parseResponse(xhr);if(xhr.status===200&&!res.error){if(res.comment_id){var new_obj={'id':res.comment_id,'comment':res.comment||form_vals.comment,'name':self.space_owner,'title':res.title||''};switch(this.info.mode){case'post':var parent_html=jQuery('#comment-'+form_vals.parent).get(0);if(!parent_html){parent_html=jQuery(self.el).find('div.threadedcomments-container')[0];}
var ul=this.info.target=document.createElement('ul');ul.setAttribute('class','comment-thread');parent_html.appendChild(ul);ul.innerHTML=self.create(new_obj).text;jQuery('span.respond_prompt',ul).click(function(evt){self.open_respond(evt);});jQuery('span.edit_prompt',ul).click(function(evt){self.open_edit(evt);});break;case'update':var comment_html=jQuery('#comment-'+form_vals['edit-id']).get(0);var comp=self.components(comment_html);self.update(new_obj,comment_html);this.info.target=comp.comment;break;}
self.citationView.decorateElementLinks(this.info.target);self.set_comment_content();if(res.security_hash){self.form.elements.timestamp.value=res.timestamp;self.form.elements.security_hash.value=res.security_hash;}
self.hide_comment_form(false);jQuery("div.threaded_comment_text").show();jQuery("div.respond_to_comment_form_div").show();document.location='#comment-'+res.comment_id;}}else{self.onfail(xhr,textStatus,res.error);}};DiscussionPanelHandler.prototype.onfail=function(xhr,textStatus,errorThrown){alert("There was an error submitting your comment!  Please report this to the system administrator: "+
errorThrown);};DiscussionPanelHandler.prototype.parseResponse=function(xhr){var rv={};var error_regex=/class="error"\s+>[^>]+>([\w ]+)<\/label/g;var error=error_regex.exec(xhr.responseText);if(error!==null){rv.error='Required Fields: ';do{rv.error+=error[1]+';';}while((error=error_regex.exec(xhr.responseText))!==null);}
var new_comment=String(xhr.responseText).match(/#comment-(\d+)/);if(new_comment!==null){rv.comment_id=new_comment[1];}
var timestamp=String(xhr.responseText).match(/name="timestamp"\s+value="(\d+)"/);if(timestamp!==null){rv.timestamp=timestamp[1];}
var security=String(xhr.responseText).match(/name="security_hash"\s+value="(\w+)"/);if(security!==null){rv.security_hash=security[1];}
var comment_text=String(xhr.responseText).match(/id="commentposted">((.|\n)*)<!--endposted/);if(comment_text!==null){rv.comment=comment_text[1];}
var comment_title=String(xhr.responseText).match(/id="commenttitle">(.+)<\/h2>/);if(comment_title!==null){rv.title=comment_title[1];}
return rv;};DiscussionPanelHandler.prototype.read=function(found_obj){var c=this.components(found_obj.html);var comment=c.comment.cloneNode(true);jQuery('.postupdate',comment).remove();return{'name':c.author.firstChild.nodeValue,'comment':comment.innerHTML,'title':(c.title)?c.title.innerHTML:'','id':String(c.top.id).substr(8),'editable':Boolean(c.edit_button),'base_comment':!c.parent};};DiscussionPanelHandler.prototype.update=function(obj,html_dom,components){var self=this;var success=0;components=components||this.components(html_dom);if(obj.comment){success+=jQuery(components.comment).html(obj.comment).length;}
if(obj.title){success+=jQuery(components.title).html(obj.title).length;if(!components.parent){document.title=obj.title;jQuery(self.el).find("h1.discussion-title").html(obj.title);}}
return success;};DiscussionPanelHandler.prototype.components=function(html_dom,create_obj){return{'top':html_dom,'comment':jQuery('div.threaded_comment_text:first',html_dom).get(0),'title':jQuery('div.threaded_comment_title',html_dom).get(0),'author':jQuery('span.threaded_comment_author:first',html_dom).get(0),'edit_button':jQuery('div.respond_to_comment_form_div:first span.edit_prompt',html_dom).get(0),'parent':jQuery(html_dom).parents('li.comment-thread').get(0)};};DiscussionPanelHandler.prototype.create=function(obj,doc){var html='<li id="comment-{{current_comment.id}}"'+'class="comment-thread">'+'<div class="comment new-comment">'+' <div class="threaded_comment_header">'+'<span class="threaded_comment_author">{{current_comment.name}}</span>&nbsp;'+'said:'+'<div class="respond_to_comment_form_div" id="respond_to_comment_form_div_id_{{current_comment.id}}">'+'<span class="respond_prompt comment_action" data-comment="{{current_comment.id}}" title="Click to show or hide the comment form">'+'Respond<!-- to comment {{current_comment.id}}: --></span>'+' <span class="edit_prompt comment_action" data-comment="{{current_comment.id}}" title="Click to show or hide the edit comment form">Edit</span>'+'<div class="comment_form_space"></div>'+'</div>'+' </div>'+'<div class="threaded_comment_title">{{current_comment.title}}</div>'+'<div class="threaded_comment_text">'+'{{current_comment.comment|safe}}'+'</div>'+'</div>'+'</li>';var text=html.replace(/\{\{current_comment\.id\}\}/g,obj.id).replace(/\{\{current_comment.name\}\}/g,obj.name).replace(/\{\{current_comment.title\}\}/g,obj.title||'').replace(/\{\{current_comment\.comment\|safe\}\}/g,obj.comment);return{htmlID:'comment-'+obj.id,object:obj,text:text};};DiscussionPanelHandler.prototype.readonly=function(){var self=this;self.citationView.unload();if(self.tinyMCE){self.tinyMCE.plugins.editorwindow._closeWindow();}
if(!jQuery(self.form).is(":visible")){jQuery(self.el).find("td.panhandle-stripe div.label").html("Insert Selections");jQuery(self.el).find("div.asset-view-published").hide();self.citationView.unload();jQuery(self.el).find("div.collection-materials").show();jQuery(self.el).find("input.project-title").show();jQuery(self.el).find("input.participants_toggle").show();self.tinyMCE.show();}else{jQuery(self.el).find("div.collection-materials").hide();jQuery(self.el).find("td.panhandle-stripe div.label").html("View Inserted Selections");jQuery(self.el).find("div.asset-view-published").show();}
jQuery(self.el).find("td.panel-container").toggleClass("media collection");jQuery(self.el).find("td.panhandle-stripe").toggleClass("media collection");jQuery(self.el).find("div.pantab").toggleClass("media collection");jQuery(window).trigger("resize");return false;};function ajaxDelete(link,container,opts){var postUrl=null;if(link&&link.href){postUrl=link.href;}else if(opts&&opts.href){postUrl=opts.href;}else{alert("An error occurred. Unable to delete this item.");}
var dom=document.getElementById(container);jQuery(dom).addClass('about-to-delete');var msg="Are you sure you want to delete this?";if(opts){if(opts.item){msg="Are you sure you want to remove this item from your collection?";}else if(opts.object_type){msg="Are you sure you want to delete this "+opts.object_type+"?";}}
if(confirm(msg)){jQuery.ajax({type:'POST',url:postUrl,success:function(responseText,textStatus,xhr){if(xhr.status===200){jQuery(dom).fadeOut(function(){jQuery(dom).remove();});}else{alert("Error: "+textStatus);}
if(opts&&opts.success){opts.success();}},error:function(xhr){window.sky=xhr;alert("Error!");}});}else{jQuery(dom).removeClass('about-to-delete');}
return false;}